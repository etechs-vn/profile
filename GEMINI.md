# GEMINI.md - Project Context & Instructions

## 1. Project Overview
**Name:** Profile Service
**Type:** Multi-Tenant Backend Service (FastAPI)
**Purpose:** Manages user profiles and social interactions in a multi-tenant environment. It supports role-based profiles (Student vs. Teacher) and isolated data storage for each tenant.

### Core Architecture
- **Framework:** FastAPI (Python 3.13+)
- **Database:** SQLAlchemy (Async)
  - **Shared Database:** Stores global entities like `Users` and `Tenants`.
  - **Tenant Databases:** Isolated databases (SQLite for Dev, PostgreSQL for Prod) for tenant-specific data (Profiles, Documents, Social graph).
- **Multi-tenancy Strategy:** Database-per-tenant. The system dynamically routes requests to the correct database engine based on the `tenant_id`.

## 2. Directory Structure
```
/
├── app/                  # Source Code
│   ├── api/              # API Endpoints (Versioned v1)
│   ├── core/             # Config & Settings
│   ├── db/               # Database Logic (Session, Base, Manager)
│   ├── models/           # SQLAlchemy Models
│   ├── schemas/          # Pydantic Schemas
│   └── services/         # Business Logic Layer
├── bruno/                # API Testing Collections (Bruno)
├── pyproject.toml        # Project Dependencies (uv/pip)
├── quy-trinh.md          # Business Logic & Workflows (Vietnamese)
└── EXAMPLES.md           # Usage Examples & curl commands
```

## 3. Development Workflow

### Dependency Management
This project uses `uv` for dependency management.
```bash
# Install dependencies
uv sync
```

### Running the Application
```bash
# Start server with hot-reload
uv run uvicorn app.main:app --reload
```
- **Local URL:** `http://localhost:8000`
- **Docs:** `http://localhost:8000/docs`

### Testing
- **Manual:** Use the **Bruno** collections located in the `bruno/` directory.
- **Automated:** No explicit test runner found yet (check `tests/` if created).

## 4. Key Components & Conventions

### Database Manager (`app/db/database_manager.py`)
- **Shared Engine:** Initialized on startup (`shared.db` or Postgres).
- **Tenant Engine:** Lazily initialized/cached.
- **Routing:**
  - `get_shared_engine()`: For Users/Tenants.
  - `get_tenant_engine(tenant_id)`: For Profiles/Documents.

### Business Logic (`quy-trinh.md`)
- **Profile Creation:** Automatically created upon User registration.
- **Roles:**
  - **Student:** Includes School, Class, Major.
  - **Teacher:** Includes Department, Subject, Title.
- **Social Interaction:** Each profile has a "Social Page" for posts/comments, stored in the Tenant DB.

### Code Style
- **Async/Await:** All database interactions must be asynchronous.
- **Typing:** Strict Python type hints.
- **Pydantic:** Used for all Request/Response validation.
- **Layered Architecture:** Endpoint -> Service -> DB.

## 5. API Usage Patterns
- **Shared Resources:** `/shared/...` (e.g., `/shared/users`)
- **Tenant Resources:** `/tenants/{tenant_id}/...` (e.g., `/tenants/tenant_001/profiles`)
- **Headers:** Some endpoints may accept `X-Tenant-ID` for context.

---
*Generated by Gemini Agent on 2026-01-15*
